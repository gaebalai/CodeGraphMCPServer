# CodeGraph MCP Server 아키텍처 개요 설계서

**Project**: CodeGraph MCP Server  
**Version**: 1.0.0  
**Created**: 2025-11-26  
**Status**: Draft  
**Document Type**: C4 Model - Context & Container Diagrams

---

## 1. 문서 개요

### 1.1 목적

본 문서는 CodeGraph MCP Server의 시스템 아키텍처를 C4 모델을 기반으로 기술합니다.

### 1.2 범위

- 시스템 컨텍스트 (Level 1)
- 컨테이너 다이어그램 (Level 2)
- 주요 컴포넌트 개요
- 외부 시스템 연동

### 1.3 관련 문서

| 문서 | 참조 위치 |
|-------------|--------|
| 요구사항 정의서 | storage/specs/requirements-specification.md |
| 코어 엔진 설계서 | storage/specs/design-core-engine.md |
| MCP 인터페이스 설계서 | storage/specs/design-mcp-interface.md |
| 스토리지 설계서 | storage/specs/design-storage.md |
| ADR | storage/specs/design-adr.md |

---

## 2. C4 모델 - Level 1: 시스템 컨텍스트 다이어그램

### 2.1 컨텍스트 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         External Systems                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐│
│  │   GitHub     │  │   Claude     │  │   Cursor     │  │  Windsurf    ││
│  │   Copilot    │  │    Code      │  │    IDE       │  │    IDE       ││
│  │              │  │              │  │              │  │              ││
│  │  [MCP Client]│  │  [MCP Client]│  │  [MCP Client]│  │  [MCP Client]││
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘│
│         │                 │                 │                 │         │
│         │    MCP Protocol (stdio/SSE)       │                 │         │
│         └─────────────────┼─────────────────┴─────────────────┘         │
│                           │                                              │
│                           ▼                                              │
│         ┌─────────────────────────────────────┐                         │
│         │                                      │                         │
│         │     CodeGraph MCP Server            │                         │
│         │                                      │                         │
│         │  - 소스 코드 그래프 분석            │                         │
│         │  - GraphRAG 기능                     │                         │
│         │  - 코드 구조 쿼리                  │                         │
│         │                                      │                         │
│         └─────────────────┬───────────────────┘                         │
│                           │                                              │
│                           │ File System Access                          │
│                           ▼                                              │
│         ┌─────────────────────────────────────┐                         │
│         │                                      │                         │
│         │     Source Code Repository          │                         │
│         │     (Local File System)             │                         │
│         │                                      │                         │
│         └─────────────────────────────────────┘                         │
│                                                                          │
│  ┌──────────────┐                                                       │
│  │   LLM API    │◄─── 선택 사항: 설명 생성 및 요약 생성                 │
│  │  (OpenAI 등)  │                                                       │
│  └──────────────┘                                                       │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 액터 정의

| 액터 | 설명 | 상호작용 |
|----------|------|-----------------|
| **AI 어시스턴트** | GitHub Copilot, Claude Code, Cursor 등 | MCP 프로토콜을 통해 도구/리소스/프롬프트 사용 |
| **개발자** | 개발자 | CLI를 통해 인덱스 생성, 서버 기동 |
| **소스 리포지토리** | 소스 코드 저장소 | 파일 시스템을 통한 읽기 |
| **LLM API** | 외부 LLM 서비스 (선택 사항) | 설명 및 요약 생성 시 호출 |

### 2.3 시스템 경계

| 경계 | 내부/외부 | 설명 |
|------|----------|------|
| CodeGraph MCP Server | 내부 | 본 시스템의 범위 |
| MCP 클라이언트 | 외부 | AI 어시스턴트 도구 |
| 파일 시스템 | 외부 | 소스 코드 리포지토리 |
| LLM API | 외부 | 선택적 외부 서비스 |

---

## 3. C4 모델 - Level 2: 컨테이너 다이어그램

### 3.1 컨테이너 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     CodeGraph MCP Server                                     │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        MCP Server Container                          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │   stdio      │  │     SSE      │  │  Streamable  │              │   │
│  │  │  Transport   │  │  Transport   │  │    HTTP      │              │   │
│  │  │  [REQ-TRP-001]│ │  [REQ-TRP-002]│ │  [REQ-TRP-003]│             │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │   │
│  │         └─────────────────┼─────────────────┘                       │   │
│  │                           ▼                                          │   │
│  │  ┌────────────────────────────────────────────────────────────┐    │   │
│  │  │                 MCP Interface Layer                         │    │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │    │   │
│  │  │  │   Tools     │  │  Resources  │  │   Prompts   │         │    │   │
│  │  │  │ (14 tools)  │  │ (4 types)   │  │ (6 prompts) │         │    │   │
│  │  │  │[REQ-TLS-*]  │  │[REQ-RSC-*]  │  │[REQ-PRM-*]  │         │    │   │
│  │  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │    │   │
│  │  │         └────────────────┼────────────────┘                 │    │   │
│  │  └──────────────────────────┼─────────────────────────────────┘    │   │
│  │                             │                                       │   │
│  └─────────────────────────────┼───────────────────────────────────────┘   │
│                                │                                            │
│  ┌─────────────────────────────▼───────────────────────────────────────┐   │
│  │                      Core Engine Container                           │   │
│  │                                                                      │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │   │
│  │  │ AST Parser  │  │   Graph     │  │  Semantic   │  │  Indexer   │ │   │
│  │  │             │  │   Engine    │  │  Analyzer   │  │            │ │   │
│  │  │[REQ-AST-*]  │  │[REQ-GRF-*]  │  │[REQ-SEM-*]  │  │[REQ-IDX-*] │ │   │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └─────┬──────┘ │   │
│  │         │                │                │                │        │   │
│  └─────────┼────────────────┼────────────────┼────────────────┼────────┘   │
│            │                │                │                │             │
│  ┌─────────▼────────────────▼────────────────▼────────────────▼────────┐   │
│  │                      Storage Container                               │   │
│  │                                                                      │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │   │
│  │  │   SQLite DB     │  │   File Cache    │  │  Vector Store   │     │   │
│  │  │  (Graph Data)   │  │  (AST Cache)    │  │  (Embeddings)   │     │   │
│  │  │  [REQ-STR-001]  │  │  [REQ-STR-002]  │  │  [REQ-STR-003]  │     │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘     │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 컨테이너 정의

| 컨테이너 | 기술 | 책임 | 요구사항 ID |
|----------|------|------|------------|
| **MCP Server** | Python, mcp-sdk | MCP 프로토콜 처리, 트랜스포트 관리 | REQ-TRP-001~005 |
| **MCP Interface** | Python | Tools / Resources / Prompts 제공 | REQ-TLS / RSC / PRM-* |
| **Core Engine** | Python, Tree-sitter, NetworkX | AST 분석, 그래프 구축, 시맨틱 분석 | REQ-AST / GRF / SEM / IDX-* |
| **Storage** | SQLite, aiosqlite | 데이터 영속화, 캐시 관리 | REQ-STR-001~004 |

### 3.3 컨테이너 간 통신

| 소스 | 타깃 | 프로토콜 | 설명 |
|--------|----------|----------|------|
| MCP Client | MCP Server | stdio / SSE / HTTP | MCP Protocol (JSON-RPC 2.0) |
| MCP Interface | Core Engine | Python API | 동기 / 비동기 함수 호출 |
| Core Engine | Storage | SQL / File I/O | 데이터 읽기 / 쓰기 |
| Semantic Analyzer | LLM API | HTTPS | 설명 및 요약 생성 (선택 사항) |

---

## 4. 아키텍처 원칙

### 4.1 설계 원칙

| 원칙 | 설명 | Constitutional Article |
|------|------|------------------------|
| **Library-First** | 모든 기능을 독립 라이브러리로 구현 | Article I |
| **CLI Interface** | 모든 라이브러리는 CLI를 통해 접근 가능 | Article II |
| **Self-Contained** | 외부 DB 불필요, SQLite 내장 | - |
| **Zero-Config** | `pip install && serve` 만으로 즉시 사용 가능 | - |
| **Incremental** | Git diff 기반 증분 인덱싱 | - |

### 4.2 품질 속성

| 속성 | 목표 | 측정 방법 |
|------|------|-----------|
| **Performance** | 10만 라인 기준 30초 이내 | 벤치마크 테스트 |
| **Latency** | 쿼리 500ms 이내 | 응답 시간 측정 |
| **Memory** | 500MB 이하 | 메모리 프로파일링 |
| **Startup** | 2초 이내 | 기동 시간 측정 |

### 4.3 제약 사항

| 제약 | 설명 | 근거 |
|------|------|------|
| Python 3.11+ | 최소 Python 버전 | 타입 힌트, 성능 |
| SQLite | 그래프 스토리지 | 자기완결형, 제로 설정 |
| MCP 1.0 | 프로토콜 버전 | 사양 준수 |
| 프로젝트 3개 이하 | 초기 프로젝트 수 제한 | Article VII |

---

## 5. 배포 아키텍처

### 5.1 배포 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                    Developer Machine                             │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   IDE / Editor                            │  │
│  │  ┌────────────────┐  ┌────────────────┐                  │  │
│  │  │ VS Code +      │  │    Cursor      │                  │  │
│  │  │ GitHub Copilot │  │                │                  │  │
│  │  └───────┬────────┘  └───────┬────────┘                  │  │
│  │          │                    │                           │  │
│  │          │     stdio          │                           │  │
│  │          ▼                    ▼                           │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │            CodeGraph MCP Server Process            │  │  │
│  │  │                                                    │  │  │
│  │  │   codegraph-mcp serve --repo /path/to/project     │  │  │
│  │  │                                                    │  │  │
│  │  └───────────────────────┬────────────────────────────┘  │  │
│  │                          │                                │  │
│  └──────────────────────────┼────────────────────────────────┘  │
│                             │                                    │
│  ┌──────────────────────────▼────────────────────────────────┐  │
│  │                    Local File System                       │  │
│  │                                                            │  │
│  │  ┌─────────────────┐  ┌─────────────────────────────────┐│  │
│  │  │ ~/.codegraph/   │  │     /path/to/project/          ││  │
│  │  │                 │  │                                 ││  │
│  │  │ ├── index.db    │  │ ├── src/                       ││  │
│  │  │ ├── cache/      │  │ ├── tests/                     ││  │
│  │  │ └── vectors/    │  │ └── ...                        ││  │
│  │  │                 │  │                                 ││  │
│  │  │ [CodeGraph Data]│  │ [Source Code Repository]       ││  │
│  │  └─────────────────┘  └─────────────────────────────────┘│  │
│  │                                                            │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 5.2 배포 구성

| 구성 | 설명 | 유스케이스 |
|------|------|------------|
| **Local Process** | 로컬 머신에서 실행되는 프로세스 | 개인 개발 |
| **Docker Container** | 컨테이너화된 실행 환경 | CI/CD 통합 |
| **Remote Server** | 원격 서버에서 구동 | 팀 공유 (향후) |

### 5.3 설치 방법

```bash
# PyPI 경유
pip install codegraph-mcp

# GitHub 경유
pip install git+https://github.com/gaebalai/CodeGraphMCPServer.git

# 개발 모드
git clone https://github.com/gaebalai/CodeGraphMCPServer.git
cd CodeGraphMCPServer
pip install -e .
```

### 5.4 MCP Client 설정 예시

#### Claude Desktop (claude_desktop_config.json)

```json
{
  "mcpServers": {
    "codegraph": {
      "command": "codegraph-mcp",
      "args": ["serve", "--repo", "/path/to/your/project"]
    }
  }
}
```

#### VS Code Settings

```json
{
  "github.copilot.chat.mcpServers": {
    "codegraph": {
      "command": "codegraph-mcp",
      "args": ["serve", "--repo", "${workspaceFolder}"]
    }
  }
}
```

---

## 6. 데이터 흐름

### 6.1 인덱스 생성 흐름

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  CLI    │────▶│   Indexer   │────▶│  AST Parser │────▶│   Graph     │
│ command │     │             │     │             │     │   Engine    │
└─────────┘     └──────┬──────┘     └─────────────┘     └──────┬──────┘
                       │                                        │
                       │ 1. Collect files                       │ 3. Store entities
                       │ 2. Check git diff                      │ 4. Store relations
                       ▼                                        ▼
               ┌───────────────┐                        ┌───────────────┐
               │  File System  │                        │    SQLite     │
               │  (Source)     │                        │   (Graph DB)  │
               └───────────────┘                        └───────────────┘
```

### 6.2 쿼리 처리 흐름

```
┌───────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│MCP Client │────▶│ MCP Server  │────▶│   Tools     │────▶│   Graph     │
│  (query)  │     │(JSON-RPC)   │     │ (handler)   │     │   Engine    │
└───────────┘     └─────────────┘     └─────────────┘     └──────┬──────┘
                                                                  │
      ┌───────────────────────────────────────────────────────────┘
      │
      ▼
┌───────────────┐     ┌───────────────┐
│    SQLite     │────▶│    Result     │────▶ Response to Client
│   (Query)     │     │  Formatting   │
└───────────────┘     └───────────────┘
```

### 6.3 GraphRAG 쿼리 흐름 (Phase 2)

```
┌───────────────┐     ┌─────────────┐     ┌─────────────┐
│ global_search │────▶│  Community  │────▶│   LLM API   │
│    Tool       │     │  Summaries  │     │ (optional)  │
└───────────────┘     └─────────────┘     └──────┬──────┘
                                                  │
                                                  ▼
                                          ┌─────────────┐
                                          │  Aggregated │
                                          │   Response  │
                                          └─────────────┘
```

---

## 7. 보안 아키텍처

### 7.1 보안 경계

```
┌─────────────────────────────────────────────────────────────────┐
│                      Trust Boundary                              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    MCP Server                              │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │  │
│  │  │  Allowed    │  │  Sandboxed  │  │  Path           │   │  │
│  │  │  Repository │  │  Shell      │  │  Restriction    │   │  │
│  │  │  Paths      │  │  Execution  │  │  Enforcement    │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Restricted Access                             │  │
│  │  - File system access limited to --repo path               │  │
│  │  - Shell commands with timeout (REQ-NFR-012)               │  │
│  │  - No network access except LLM API (optional)             │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 보안 대책

| 위협 | 대응책 | 요구사항 ID |
|------|--------|-------------|
| 경로 탐색 공격 | 리포지토리 경로 제한 | REQ-NFR-013 |
| 커맨드 인젝션 | 셸 실행 샌드박스화 | REQ-NFR-012 |
| DoS 공격 | 타임아웃 제한 | REQ-NFR-012 |
| 인증 우회 | OAuth 2.1 (P2) | REQ-TRP-005 |

---

## 8. 에러 핸들링 전략

### 8.1 에러 분류

| 카테고리 | 예시 | 대응 |
|----------|------|------|
| **복구 가능** | 파싱 에러, 파일 미존재 | 로그 기록 후 처리 지속 |
| **일시적** | 네트워크 에러 | 재시도 |
| **치명적** | DB 손상, 메모리 부족 | 프로세스 종료 및 복구 절차 수행 |

### 8.2 에러 복구

| 시나리오 | 복구 방법 | 요구사항 ID |
|----------|----------|-------------|
| 서버 크래시 | 인덱스 자동 복원 | REQ-NFR-008 |
| 파싱 에러 | 부분 분석 유지 | REQ-AST-005 |
| 인덱스 손상 | 전체 재인덱싱 | REQ-IDX-003 |

---

## 9. 확장성 설계

### 9.1 언어 확장

```python
# languages/config.py - 신규 언어 추가 패턴
LANGUAGE_CONFIGS = {
    "python": {
        "extensions": [".py"],
        "parser": "tree-sitter-python",
        "node_types": {...}
    },
    # 신규 언어 추가
    "go": {
        "extensions": [".go"],
        "parser": "tree-sitter-go",
        "node_types": {...}
    }
}
```

### 9.2 도구 확장

```python
# mcp/tools.py - 신규 도구 추가 패턴
@server.tool()
async def new_tool(param: str) -> str:
    """새로운 도구에 대한 설명"""
    # 実装
    pass
```

---

## 10. 요구사항 트레이서빌리티

### 10.1 아키텍처 → 요구사항 매핑

| 아키텍처 요소             | 요구사항 ID               | 설명       |
| ------------------- | --------------------- | -------- |
| MCP Server 컨테이너     | REQ-TRP-001~005       | 트랜스포트 계층 |
| MCP Interface 계층    | REQ-TLS/RSC/PRM-*     | MCP 기능   |
| Core Engine 컨테이너    | REQ-AST/GRF/SEM/IDX-* | 코어 기능    |
| Storage 컨테이너        | REQ-STR-001~004       | 스토리지     |
| Security Boundary   | REQ-NFR-012, 013      | 보안       |
| Performance Targets | REQ-NFR-001~006       | 성능       |

---

## 11. 변경 이력

| 버전    | 날짜         | 변경 내용 | 작성자    |
| ----- | ---------- | ----- | ------ |
| 1.0.0 | 2025-11-26 | 초판 작성 | System |

---

**문서 상태**: Draft  
**헌법 준수 여부**: Article VI (Project Memory), Article VII (Simplicity Gate) ✓
